const fileHelper=require("./file-helper");let _options;function readTemplateContent(e){if(!e)throw new Error("No data provided");return new Promise((function(t,n){if("string"==typeof e)return t({template:e,templateName:"custom_template"});if(e.urlTemplate)return t({template:e.urlTemplate,templateName:e.$templateName||"external_template"});if(!e.$templateName)throw new Error("No $templateName provided");fileHelper.readFile(`${_options.TEMPLATE_DIR}/${e.$templateName}.html`).then(e=>e.toString("utf8")).then(n=>{if(!("noData"in e)){var a=_getTemplateParameters(n);a.extraParams=e.$extraParams;let t=n.split(/<\/body>\n*(<\/html>)*/gm);t.push(`\n                            ${_options.libs.map(e=>'<script src="'+e+'"><\/script>').join("\n")}\n                            <script>\n                                window.onload = function () {\n                                    var vueInit = {\n                                        mixins: window.mixins,\n                                        data: ${JSON.stringify(Object.assign(a,e.$parameters))}\n                                    };\n\n                                    if (Vue.createApp) { // Vue v3\n                                        Vue.createApp(vueInit).mount('#app');\n                                    } else {\n                                        vueInit.el = '#app';\n                                        new Vue(vueInit);\n                                    }\n                                    \n                                }\n                            <\/script></body></html>`),n=t.join("")}t({template:n,templateName:e.$templateName})}).catch(n)}))}function saveOnTemp(e,t){var n=`${e}_${(new Date).getTime()}`;return"external_template"===e?Promise.resolve({fileName:n,urlTemplate:t}):fileHelper.saveFile(`${_options.FILE_DIR}/${n}.html`,t).then(()=>({fileName:n}))}function _getTemplateParameters(e){var t="",n=/((?:\{\{)\s*([\d\w$]+)\s*(?:\}\}))|(?:v-for=.+in\s)([\d\w$]+)|(?:\{\{)\s*[\d\w$\.]+\(([\d\w$]+),*[\w\s\d"'-]*\)(?:\}\})|(?:\{\{)([\d$\w]+)\.([\d$\w]+)(?:\}\})/gim,a={},i="";let r=null;for(;t=n.exec(e);)if(t)if(r=t.slice(0).filter(e=>e),r[0].match("v-for")){if(a[i=r[r.length-1]]&&Array.isArray(a[i])){a[i]=[Object.assign(a[i][0],getObjectParams(r,e))];continue}a[i]=[getObjectParams(r,e)]}else r[0].match(/(?:\{\{)([\d$\w]+)\.([\d$\w]+)(?:\}\})/)?a[r[1]]=getObjectParams(r[1],e):isNaN(r[r.length-1])&&(a[i=r.pop()]=`{{${i}}}`);return a}function getObjectParams(e,t){for(var n=new RegExp('"\\(*([\\d\\w$]+),*.*\\)*\\sin\\s'+e[e.length-1],"igm").exec(e[0])||[null,e],a=new RegExp(n[1]+"\\.([\\d\\w$]+)","igm"),i={};matched=a.exec(t);)if(matched){let e=matched.slice(0).pop();e&&(e=e.replace(/[\{\(\}\),]/g,"").split(/\s+/).shift()),i[e]=`{{${e}}}`}return i}module.exports.initialize=function(e){return _options={FILE_DIR:e.FILE_DIR,PDF_DIR:e.PDF_DIR,TEMPLATE_DIR:e.TEMPLATE_DIR,libs:e.libs||[]},_options.libs&&Array.isArray(_options.libs)&&0===_options.libs.filter(e=>/vue(\.min\.+?js)*/.test(e)).length&&_options.libs.unshift("https://cdn.jsdelivr.net/npm/vue"),{prepareTemplate:function(e){return fileHelper.ensureExitsDir([_options.FILE_DIR,_options.PDF_DIR]).then(()=>readTemplateContent(e).then(e=>saveOnTemp(e.templateName,e.template)))},deleteFile:fileHelper.deleteFile,dispose:()=>{_options=null}}},module.exports.getTemplateParameters=function(e){return readTemplateContent({$templateName:e,noData:!0}).then(e=>_getTemplateParameters(e.template))};