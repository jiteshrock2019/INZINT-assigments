const puppeteer=require("puppeteer-core"),templateInitializer=require("./helper"),logger=require("./logger");let _options,templateHelper,browser,page;const pageEvents={pageerror:e=>{logger.writeLog({text:e,type:"ERROR"})},error:e=>{logger.writeLog({text:e,type:"ERROR"})},console:e=>{let t=e.args().map(e=>{if(e&&e._remoteObject.preview&&"error"!==e._remoteObject.preview.subtype){const t=e._remoteObject.preview.properties.reduce((e,t)=>(e[t.name]=t.value,e),{});return JSON.stringify(t,null,2)}return e&&e._remoteObject.description?e._remoteObject.description:e&&e._remoteObject.value?e._remoteObject.value:void 0});logger.writeLog({text:t.join(" "),type:e.type().substr(0,3).toUpperCase()})},response:e=>{/;base64,/gi.test(e.url())||logger.writeLog({text:`${e.status()} ${e.url()}`,type:"LOG"})},requestfailed:e=>{logger.writeLog({text:`${e.failure().errorText} ${e.url()}`,type:"ERROR"})}};async function init(){if(!browser||!page){if(!_options.URL_BROWSER)throw new Error("No target browser found");logger.writeLog({text:"Launching Browser",type:"LOG"}),browser=await puppeteer.launch({executablePath:_options.URL_BROWSER,product:_options.BROWSER_NAME}),logger.writeLog({text:"Starting Page",type:"LOG"}),page=await browser.newPage();for(let e in pageEvents)pageEvents.hasOwnProperty(e)&&page.on(e,pageEvents[e])}}async function closeBrowser(){if(templateHelper&&(templateHelper.dispose(),templateHelper=null),_options=null,page){for(let e in pageEvents)pageEvents.hasOwnProperty(e)&&page.off(e,pageEvents[e]);logger.writeLog({text:"Closing Browser",type:"LOG"}),page=null}browser&&(await browser.close(),browser=null)}function processTemplate(e){return new Promise(async(t,r)=>{try{await init();let r=await templateHelper.prepareTemplate(e),o=`http://localhost${_options.PORT&&":"+_options.PORT||""}/${r.fileName}.html`;r.urlTemplate&&(o=r.urlTemplate||o),logger.writeLog({text:"Loading "+o,type:"LOG"}),await page.goto(o,{waitUntil:"networkidle0"});const a=await __getFooterTemplateFromTemplate(page),i=await __getHeaderTemplateFromTemplate(page);logger.writeLog({text:"Creating PDF",type:"LOG"});const n={path:`${_options.PDF_DIR}/${r.fileName}.pdf`,format:"Letter",printBackground:!0,displayHeaderFooter:!0,footerTemplate:a.footerTemplate,headerTemplate:i.headerTemplate,margin:{top:i.marginTop,bottom:a.marginBottom,left:_options.printingMarginLeft,right:_options.printingMarginRight}};e.$extraParams&&e.$extraParams.orientation&&"horizontal"===e.$extraParams.orientation&&(n.landscape=!0,page.addStyleTag({content:"@page { size: A4 landscape; }"}));const p=await page.pdf(n);t({fileName:r.fileName+".pdf",buffer:p}),templateHelper.deleteFile(`${_options.FILE_DIR}/${r.fileName}.html`)}catch(e){logger.writeLog({text:e.stack,type:"ERROR"}),r(e.message)}})}async function __getFooterTemplateFromTemplate(e){try{return await e.$eval("#page-footer",e=>{const t={marginBottom:e.dataset.marginBottom||_options.printingMarginBottom,footerTemplate:e.outerHTML};return e.style.display="none",t})}catch(e){logger.writeLog({text:e.message+". No footer template found",type:"WARN"})}return{footerTemplate:'<div style="margin: 0 13mm;display: flex; align-items: center; width:100%;justify-content: flex-end;">\n    <p style="font-size: 8px;text-align: right; align-self: flex-end;">\n        [<span class="pageNumber"></span>/<span class="totalPages"></span>]\n    </p>\n</div>',marginBottom:_options.printingMarginBottom}}async function __getHeaderTemplateFromTemplate(e){try{return await e.$eval("#page-header",e=>{const t={marginTop:e.dataset.marginTop||_options.printingMarginTop,headerTemplate:e.outerHTML};return e.style.display="none",t})}catch(e){logger.writeLog({text:e.message+". No header template found",type:"WARN"})}return{headerTemplate:"<span></span>",marginTop:_options.printingMarginTop}}module.exports.initialize=function(e){const{BROWSER_NAME:t="chrome",URL_BROWSER:r,FILE_DIR:o,PDF_DIR:a,PORT:i,printingMarginTop:n="18mm",printingMarginBottom:p="18mm",printingMarginLeft:g="18mm",printingMarginRight:l="18mm",TEMPLATE_DIR:s,libs:m}=e;return _options={BROWSER_NAME:t,URL_BROWSER:r,FILE_DIR:o,PDF_DIR:a,PORT:i,printingMarginTop:n,printingMarginBottom:p,printingMarginLeft:g,printingMarginRight:l,TEMPLATE_DIR:s,libs:m},templateHelper=templateInitializer.initialize(_options),{processTemplate:processTemplate,dispose:async()=>{await closeBrowser()}}};